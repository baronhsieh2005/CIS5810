<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bench Press Phase Detector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: dark light;
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #1f2933, #050816);
      color: #e5e7eb;
    }

    .container {
      width: 100%;
      max-width: 640px;
      margin: 16px;
      padding: 24px;
      border-radius: 18px;
      background: rgba(15, 23, 42, 0.95);
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    h1 {
      margin-top: 0;
      margin-bottom: 4px;
      font-size: 1.5rem;
      letter-spacing: 0.03em;
    }

    .subtitle {
      margin-top: 0;
      margin-bottom: 16px;
      font-size: 0.9rem;
      color: #9ca3af;
    }

    .upload-area {
      border: 2px dashed rgba(148, 163, 184, 0.6);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background-color 0.2s, transform 0.15s;
      background: rgba(15, 23, 42, 0.8);
    }

    .upload-area:hover {
      border-color: #38bdf8;
      background: rgba(15, 23, 42, 0.95);
      transform: translateY(-1px);
    }

    .upload-area.dragover {
      border-color: #22c55e;
      background: rgba(21, 128, 61, 0.2);
    }

    .upload-text-main {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .upload-text-sub {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    #file-input {
      display: none;
    }

    .preview-wrapper {
      margin-top: 16px;
      display: none;
    }

    .preview-title {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-bottom: 6px;
    }

    .preview {
      width: 100%;
      max-height: 280px;
      object-fit: contain;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: #020617;
    }

    .controls {
      margin-top: 16px;
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-start;
      flex-wrap: wrap;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      background: linear-gradient(135deg, #38bdf8, #22c55e);
      color: #020617;
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
      box-shadow: 0 8px 20px rgba(34, 197, 94, 0.35);
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    button:not(:disabled):hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 12px 30px rgba(34, 197, 94, 0.45);
    }

    .status {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .result-card {
      margin-top: 20px;
      padding: 16px;
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(56, 189, 248, 0.5);
    }

    .result-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .phase-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.6);
    }

    .phase-pill span.dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
    }

    .phase-label {
      font-size: 1.2rem;
      font-weight: 600;
      text-transform: capitalize;
    }

    .confidence {
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .bar-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.85rem;
      margin-top: 6px;
    }

    .bar-label {
      display: flex;
      justify-content: space-between;
      color: #e5e7eb;
    }

    .bar-track {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      overflow: hidden;
      border: 1px solid rgba(30, 64, 175, 0.6);
    }

    .bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #38bdf8, #22c55e);
      transition: width 0.3s ease-out;
    }

    .error {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      background: rgba(127, 29, 29, 0.9);
      border: 1px solid rgba(248, 113, 113, 0.7);
      color: #fecaca;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Bench Press Phase Detector</h1>
    <p class="subtitle">
      Upload a bench-press frame and weâ€™ll classify it as
      <strong>lowering</strong> or <strong>pushing</strong> using your YOLO + DINOv3 model.
    </p>

    <div id="upload-area" class="upload-area">
      <p class="upload-text-main">Click to choose a photo</p>
      <p class="upload-text-sub">or drag &amp; drop a bench press frame here (JPG/PNG)</p>
      <input id="file-input" type="file" accept="image/*" />
    </div>

    <div class="preview-wrapper" id="preview-wrapper">
      <div class="preview-title">Selected image</div>
      <img id="preview-image" class="preview" src="" alt="Preview" />
    </div>

    <div class="controls">
      <button id="predict-btn" disabled>Run Prediction</button>
      <span class="status" id="status-text">No image selected.</span>
    </div>

    <div id="result" class="result-card" style="display: none;">
      <div class="result-header">
        <div>
          <div class="phase-pill">
            <span class="dot"></span>
            <span>Prediction</span>
          </div>
          <div class="phase-label" id="phase-label"></div>
        </div>
        <div class="confidence" id="confidence-text"></div>
      </div>

      <div class="bar-row">
        <div class="bar-label">
          <span>Lowering</span>
          <span id="prob-lowering-text">0.00</span>
        </div>
        <div class="bar-track">
          <div class="bar-fill" id="prob-lowering-bar"></div>
        </div>
      </div>

      <div class="bar-row">
        <div class="bar-label">
          <span>Pushing</span>
          <span id="prob-pushing-text">0.00</span>
        </div>
        <div class="bar-track">
          <div class="bar-fill" id="prob-pushing-bar"></div>
        </div>
      </div>
    </div>

    <div id="error-box" class="error" style="display: none;"></div>
  </div>

  <script>
    // Change this if your backend runs elsewhere
    const API_URL = "http://localhost:8000/predict";

    const uploadArea = document.getElementById("upload-area");
    const fileInput = document.getElementById("file-input");
    const previewWrapper = document.getElementById("preview-wrapper");
    const previewImage = document.getElementById("preview-image");
    const predictBtn = document.getElementById("predict-btn");
    const statusText = document.getElementById("status-text");
    const resultCard = document.getElementById("result");
    const phaseLabelEl = document.getElementById("phase-label");
    const confidenceText = document.getElementById("confidence-text");
    const probLoweringText = document.getElementById("prob-lowering-text");
    const probPushingText = document.getElementById("prob-pushing-text");
    const probLoweringBar = document.getElementById("prob-lowering-bar");
    const probPushingBar = document.getElementById("prob-pushing-bar");
    const errorBox = document.getElementById("error-box");

    let selectedFile = null;

    function resetResult() {
      resultCard.style.display = "none";
      errorBox.style.display = "none";
      probLoweringBar.style.width = "0%";
      probPushingBar.style.width = "0%";
    }

    function showError(msg) {
      errorBox.textContent = msg;
      errorBox.style.display = "block";
      resultCard.style.display = "none";
    }

    function handleFile(file) {
      if (!file) return;
      if (!file.type.startsWith("image/")) {
        showError("Please upload a valid image file.");
        return;
      }

      selectedFile = file;
      resetResult();

      const reader = new FileReader();
      reader.onload = (e) => {
        previewImage.src = e.target.result;
        previewWrapper.style.display = "block";
        predictBtn.disabled = false;
        statusText.textContent = "Ready to predict.";
      };
      reader.readAsDataURL(file);
    }

    // Click to open file picker
    uploadArea.addEventListener("click", () => {
      fileInput.click();
    });

    // File selected via picker
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      handleFile(file);
    });

    // Drag & drop
    uploadArea.addEventListener("dragover", (e) => {
      e.preventDefault();
      uploadArea.classList.add("dragover");
    });

    uploadArea.addEventListener("dragleave", (e) => {
      e.preventDefault();
      uploadArea.classList.remove("dragover");
    });

    uploadArea.addEventListener("drop", (e) => {
      e.preventDefault();
      uploadArea.classList.remove("dragover");
      const file = e.dataTransfer.files[0];
      handleFile(file);
    });

    // Call backend
    predictBtn.addEventListener("click", async () => {
      if (!selectedFile) {
        showError("No image selected.");
        return;
      }

      resetResult();
      predictBtn.disabled = true;
      statusText.textContent = "Running prediction...";

      try {
        const formData = new FormData();
        formData.append("file", selectedFile);

        const res = await fetch(API_URL, {
          method: "POST",
          body: formData,
        });

        if (!res.ok) {
          let detail = "Prediction failed.";
          try {
            const err = await res.json();
            if (err && err.detail) {
              detail = err.detail;
            }
          } catch (_) {}
          showError(detail);
          statusText.textContent = "Error during prediction.";
          predictBtn.disabled = false;
          return;
        }

        const data = await res.json();
        const phase = data.phase;
        const probs = data.probabilities || {};
        const pLowering = probs.lowering ?? 0;
        const pPushing = probs.pushing ?? 0;

        phaseLabelEl.textContent = phase;
        const confidence = phase === "lowering" ? pLowering : pPushing;
        confidenceText.textContent = `Confidence: ${(confidence * 100).toFixed(1)}%`;

        probLoweringText.textContent = (pLowering * 100).toFixed(1) + "%";
        probPushingText.textContent = (pPushing * 100).toFixed(1) + "%";
        probLoweringBar.style.width = (pLowering * 100).toFixed(1) + "%";
        probPushingBar.style.width = (pPushing * 100).toFixed(1) + "%";

        resultCard.style.display = "block";
        errorBox.style.display = "none";
        statusText.textContent = "Prediction complete.";
      } catch (err) {
        console.error(err);
        showError("Network error. Make sure the backend is running.");
        statusText.textContent = "Network error.";
      } finally {
        predictBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
